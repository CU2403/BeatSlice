{% extends "layout.html" %}
{% block content %}
<style>
  .master-control {
    background: #f1f3f5;
    border-radius: 0.75rem;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    max-width: 800px;
    margin: 0 auto 2rem;
  }
  .master-play-btn {
    width: 40px;
    height: 40px;
    border: 2px solid #2154FF;
    border-radius: 0.5rem;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  .master-play-btn:hover {
    background: rgba(33,84,255,0.1);
  }
  .master-play-btn.active {
    background: rgba(33,84,255,0.2);
  }

  .master-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    cursor: pointer;
  }
  .master-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px;
    height: 12px;
    background: #2154FF;
    border-radius: 50%;
    cursor: pointer;
  }

  .stem-button {
    width: 100px;
    height: 100px;
    border: 2px solid transparent;
    border-radius: 1rem;
    font-weight: 700;
    font-size: 1rem;
    color: #fff;
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.2s, border-color 0.2s, opacity 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .stem-button.drums  { background-color: #2EBB46; }
  .stem-button.vocals { background-color: #F4BC17; }
  .stem-button.bass   { background-color: #DB2E38; }
  .stem-button.melody { background-color: #2E2E36; }
  .stem-button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .stem-button.active {
    border-color: #2154FF;
    opacity: 0.8;
  }

  .stem-row {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    justify-content: center;
  }
  .stem-canvas {
    flex-grow: 1;
    height: 80px;
    background: #f1f3f5;
    border-radius: 0.75rem;
  }
</style>

<div class="container py-5">
  <div class="d-flex align-items-center mb-4">
    <span class="me-2">3/7</span>
    <div class="progress flex-grow-1" style="height: 12px; border-radius: 6px;">
      <div class="progress-bar" role="progressbar"
           style="width: 42.85%;"
           aria-valuenow="42.85" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  </div>

  <div class="master-control">
    <div id="master-play-btn" class="master-play-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="#2154FF" xmlns="http://www.w3.org/2000/svg">
        <path d="M8 5v14l11-7z"/>
      </svg>
    </div>
    <input id="master-slider" type="range" min="0" max="100" step="0.1" class="master-slider" value="0">
  </div>

  {% for stem in ['drums_03','vocals_03','bass_03','melody_03'] %}
    <div class="stem-row">
      <div
        class="stem-button {{ 'drums' if stem.startswith('drums') else
                             'vocals' if stem.startswith('vocals') else
                             'bass' if stem.startswith('bass') else
                             'melody' }}"
        data-track="{{ stem }}">
        {{ stem.split('_')[0].capitalize() }}
      </div>
      <canvas id="canvas-{{ stem }}" class="stem-canvas"></canvas>
      <audio id="{{ stem }}" src="{{ url_for('static', filename='audio/' + stem + '.wav') }}"></audio>
    </div>
  {% endfor %}

  <div class="d-flex justify-content-between">
    <a href="{{ url_for('learn2') }}" class="btn btn-back">BACK</a>
    <a href="{{ url_for('learn4') }}" class="btn btn-primary-custom">NEXT</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tracks = ['drums_03','vocals_03','bass_03','melody_03'];
  const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const audioEls = {}, analysers = {};

  tracks.forEach(id => {
    const el = document.getElementById(id);
    audioEls[id] = el;
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    analysers[id] = analyser;
    audioCtx.createMediaElementSource(el).connect(analyser).connect(audioCtx.destination);
    const canvas = document.getElementById(`canvas-${id}`);
    const ctx = canvas.getContext('2d');
    const dataArr = new Uint8Array(analyser.frequencyBinCount);

    function resize() {
      canvas.width = canvas.clientWidth * window.devicePixelRatio;
      canvas.height = canvas.clientHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    window.addEventListener('resize', resize);
    resize();

    (function draw() {
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(dataArr);
      ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
      const w = canvas.clientWidth / dataArr.length;
      for (let i = 0; i < dataArr.length; i++) {
        const v = dataArr[i] / 255;
        const h = v * canvas.clientHeight;
        ctx.fillStyle = `hsl(${120 * v}, 100%, 40%)`;
        ctx.fillRect(i * w, canvas.clientHeight - h, w * 0.8, h);
      }
    })();
  });

  const masterBtn = document.getElementById('master-play-btn');
  const masterSlider = document.getElementById('master-slider');

  function updateSliderBackground() {
    const pct = masterSlider.value;
    masterSlider.style.background = `linear-gradient(to right, #2154FF ${pct}%, #e9ecef ${pct}%)`;
  }

  masterBtn.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const playing = masterBtn.classList.toggle('active');
    const iconPath = masterBtn.querySelector('path');
    if (playing) {
      iconPath.setAttribute('d','M6 19h4V5H6v14zm8-14v14h4V5h-4z');
      const t0 = audioEls[tracks[0]].currentTime;
      tracks.forEach(id => {
        const el = audioEls[id];
        el.currentTime = t0;
        el.play();
        document.querySelector(`.stem-button[data-track="${id}"]`).classList.add('active');
      });
    } else {
      iconPath.setAttribute('d','M8 5v14l11-7z');
      tracks.forEach(id => {
        audioEls[id].pause();
        document.querySelector(`.stem-button[data-track="${id}"]`).classList.remove('active');
      });
    }
  });

  masterSlider.addEventListener('input', () => {
    const pct = masterSlider.value / 100;
    const dur = audioEls[tracks[0]].duration || 1;
    const t = pct * dur;
    tracks.forEach(id => { audioEls[id].currentTime = t; });
    updateSliderBackground();
  });

  audioEls[tracks[0]].addEventListener('timeupdate', () => {
    const base = audioEls[tracks[0]];
    const pct = base.duration ? (base.currentTime / base.duration) * 100 : 0;
    masterSlider.value = pct.toFixed(1);
    updateSliderBackground();
    tracks.slice(1).forEach(id => {
      const el = audioEls[id];
      if (Math.abs(el.currentTime - base.currentTime) > 0.1) {
        el.currentTime = base.currentTime;
      }
    });
  });

  document.querySelectorAll('.stem-button').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.track;
      const el = audioEls[id];
      if (audioCtx.state === 'suspended') audioCtx.resume();
      if (el.paused) {
        el.currentTime = audioEls[tracks[0]].currentTime;
        el.play();
        btn.classList.add('active');
      } else {
        el.pause();
        btn.classList.remove('active');
      }
    });
  });

  updateSliderBackground();
});
</script>
{% endblock %}
